<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Osu recomendations</title>

	<link href="http://localhost:3003/styles.css" rel="stylesheet">
	<script src="http://localhost:3003/jquery-3.7.1.min.js"></script>
	<link href="http://localhost:3003/favicon.png" rel="icon" type="image/x-icon" >
	
</head>
<body>
	<script>
		const mod_names = [
			'NF', 'EZ',
			'TD', 'HD', 'HR',
			'SD', 'DT', 'RX',
			'HT', 'NC',  'FL',
			'AP', 'SO'
		];

		const IntToMods = (mods_int) => {
			let result_mods = [];

			if (mods_int === 0){
				return ['NM'];
			}

			for ( let i = 0; i<mod_names.length; i++ ){
				if (mods_int >> i & 1){
					result_mods.push(mod_names[i]);
				}
			}
			
			return result_mods
		}

		const ModsToInt = (mods) => {
			let result = 0;

			for ( let i = 0; i<mod_names.length; i++ ){
				if (mods.indexOf(mod_names[i]) > -1){
					result = result | 1 << i;
				}
			}

			return result;
		}

		const parseNumber = (value, default_value) => {
			const result = Number(value);
			if (isNaN(result)) {
				return default_value;
			}
			return result;
		}

		const post = async (action_name, request_args) => {
			return new Promise ( (res ,rej) => 
				fetch('http://localhost:3003/' + action_name, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(request_args)
				}).then( response => response.json())
				.then( data => res (data) )
				.catch( error => {
					console.error(error);
					rej({ error });
				})
			);
		}

		let last_data = [];
		const page_size = 10;
		let current_page = 0;

		const page_control = (val) => {
			current_page += val;
            if (current_page < 0) {
                current_page = 0;
            } else if (current_page * page_size > last_data.length) {
                current_page = Math.floor(last_data.length / page_size);
            }
            render_beatmaps();
		}

		const format_time = (time_ms) => {
			let seconds = Math.floor(time_ms / 1000);
            let minutes = Math.floor(seconds / 60);
            let hours = Math.floor(minutes / 60);
            seconds %= 60;
            minutes %= 60;
            hours %= 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
		}

		const send_beatmap = (idx) => {
			post('send_beatmap_to_osu', { beatmap: last_data[idx], user: 'SadGod'})
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                    } else {
						console.log(data)
                    }
                });
		}

		const render_beatmaps = () => {
			document.getElementById('output').innerHTML = '';
			document.getElementById('current_page').innerHTML = '0 —Å—Ç—Ä.'
			if (last_data.length == 0) {
				document.getElementById('output').innerHTML = '<div class="output_element"><div class="output_error">No beatmaps found.</div></div>';
                return;
			}
			document.getElementById('current_page').innerHTML = `${current_page + 1} –∏–∑ ${Math.ceil(last_data.length / page_size)} —Å—Ç—Ä.`;
			for (let i = 0; i < page_size; i++) {
				const idx = (current_page * page_size) + i;
				if (idx >= last_data.length) {
                    break;
                }
				const beatmap = last_data[idx];

				document.getElementById('output').innerHTML += `<div class="output_element">
					<a href="https://osu.ppy.sh/beatmapsets/${beatmap.beatmapset_id}#osu/${beatmap.beatmap_id}">
						<div>
							<div class="output_preview">
								<img src="https://assets.ppy.sh/beatmaps/${beatmap.beatmapset_id}/covers/list.jpg"/>
							</div>
						</div>
						<div>
							<div class="output_title">
								${beatmap.artist} - ${beatmap.title} [${beatmap.difficulty}] by ${beatmap.creator}
							</div>
							<div class="output_params">
								<span class="output_pp">PP: ${beatmap.pp_total.toFixed(0)}</span>
								<span class="output_BPM">üéµ ${beatmap.bpm_avg.toFixed(0)}</span>
								<span class="output_stars">‚≠ê ${beatmap.stars.toFixed(2)}</span>
								<span class="output_length">üïì ${format_time(beatmap.total_time)}</span>
								<span class="output_stream">Stream: ${beatmap.stream_difficulty.toFixed(2)}</span>
								<span class="output_stream">Circles: ${beatmap.circles_percent.toFixed(2)}</span>
							</div>
						</div>
					</a>
					<div>
						<input type="button" onclick="send_beatmap(${idx});" value="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
					</div>
					
					</div>`;
			}
		}//https://b.ppy.sh/preview/1849738.mp3

		const send_request = () => {
			const request = {
				acc: parseNumber(document.getElementById('acc').value, 100),
				pp_min: parseNumber(document.getElementById('pp_min').value, 300),
				pp_max: parseNumber(document.getElementById('pp_max').value, 350),
				gamemode: parseNumber(document.getElementById('gamemode').value, 0),
				bpm_min: parseNumber(document.getElementById('bpm_min').value, 0),
				bpm_max: parseNumber(document.getElementById('bpm_max').value, 1000),
                stream_min: parseNumber(document.getElementById('stream_min').value, 0),
				stream_max: parseNumber(document.getElementById('stream_max').value, 1000),
				mods_int: ModsToInt(document.getElementById('mods_int').value),
                
			}

			console.log(request);

            post('recomend', request)
                .then(data => {
					console.log('recieved data', data)
                    if (data.error) {
                        console.error(data.error);
                    } else {
						
						last_data = data;

						last_data = last_data.map( v => ({...v, circles_percent: v.hit_count / v.slider_count }));

						sort('PP_DESC');
                    }
                }).catch( error => console.error(error));    

			return false;
		}

		const sort = (el) => {
			const value = el.value;
			last_data = last_data.sort(
				(a, b) => {
                    switch (value) {
                        case 'PP_DESC': return b.pp_total - a.pp_total;
                        case 'PP_ASC': return a.pp_total - b.pp_total;
                        case 'BPM_DESC': return b.bpm_avg - a.bpm_avg;
                        case 'BPM_ASC': return a.bpm_avg - b.bpm_avg;
                        case 'STARS_DESC': return b.stars - a.stars;
                        case 'STARS_ASC': return a.stars - b.stars;
						case 'LENGTH_DESC': return b.total_time - a.total_time;
						case 'LENGTH_ASC': return a.total_time - b.total_time;
                        case 'STREAM_DESC': return b.stream_difficulty - a.stream_difficulty;
                        case 'STREAM_ASC': return a.stream_difficulty - b.stream_difficulty;
						case 'CIRCLES_ASC': return a.circles_percent - b.circles_percent;
						case 'CIRCLES_DESC': return b.circles_percent - a.circles_percent;
                    }
                }
			);
			current_page = 0;
			render_beatmaps();
		}

		$( document ).ready( function() {
			post('get_last_params')
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                    } else {
						$('#gamemode').val(data.gamemode);
						$('#acc').val(data.acc);
						$('#pp_min').val(data.pp_min);
						$('#pp_max').val(data.pp_max);
						$('#bpm_min').val(data.bpm_min);
						$('#bpm_max').val(data.bpm_max);
						$('#stream_min').val(data.stream_min);
						$('#stream_max').val(data.stream_max);
						$('#mods_int').val(IntToMods(data.mods_int).join('+'));
                    }
                });
		});
	</script>
	
	<div class="sortation">
		<label for="sort">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
		<select id="sort" onchange="sort(this)">
			<option value="PP_DESC">PP —É–±—ã–≤</option>
            <option value="PP_ASC">PP –≤–æ–∑—Ä</option>
            <option value="BPM_DESC">üéµ BPM —É–±—ã–≤</option>
            <option value="BPM_ASC">üéµ BPM –≤–æ–∑—Ä</option>
			<option value="STARS_DESC">‚≠ê Stars —É–±—ã–≤</option>
			<option value="STARS_ASC">‚≠ê Stars –≤–æ–∑—Ä</option>
			<option value="LENGTH_DESC">üïì –î–ª–∏–Ω–∞ —É–±—ã–≤</option>
			<option value="LENGTH_ASC">üïì –î–ª–∏–Ω–∞ –≤–æ–∑—Ä</option>
			<option value="STREAM_DESC">Stream —É–±—ã–≤</option>
			<option value="STREAM_ASC">Stream –≤–æ–∑—Ä</option>
			<option value="CIRCLES_DESC">–ö—Ä—É–≥–∏ —É–±—ã–≤</option>
			<option value="CIRCLES_ASC">–ö—Ä—É–≥–∏ –≤–æ–∑—Ä</option>
		</select>		
	</div>

	<div class="pagination">
		<button onclick="page_control(-1)">–ü—Ä–µ–¥.</button>
		<span id="current_page">0 —Å—Ç—Ä.</span>
		<button onclick="page_control(1)">–°–ª–µ–¥.</button>
	</div>

	<div id="output">
	</div>

	<div class="form">
		<div class="form_name">üîç –ü–æ–∏—Å–∫ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</div>

		<div class="form_input">
			<label for="gamemode">–†–µ–∂–∏–º</label>
			<select id="gamemode">
				<option value="0">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
				<option value="1">–¢–∞–π–∫–æ</option>
				<option value="2">–ú–∞–Ω–∏—è</option>
				<option value="3">–§—Ä—É–∫—Ç—ã</option>
			</select>
		</div>

		<div class="form_input">
			<label for="acc">üéØ –¢–æ—á–Ω–æ—Å—Ç—å</label>
			<input type="number" id="acc" placeholder="accuracy" value="99" />
		</div>

		<div class="form_input">
			<label for="pp_min">PP –º–∏–Ω</label>
			<input type="number" id="pp_min" placeholder="pp min" value="300" />
		</div>

		<div class="form_input">
			<label for="pp_max">PP –º–∞–∫—Å</label>
			<input type="number" id="pp_max" placeholder="pp max" value="350" />
		</div>

		<div class="form_input">
			<label for="bpm_min">üéµ BPM –º–∏–Ω</label>
			<input type="number" id="bpm_min" placeholder="bpm min" value="0" />
		</div>

		<div class="form_input">
			<label for="bpm_max">üéµ BPM –º–∞–∫—Å</label>
			<input type="number" id="bpm_max" placeholder="bpm max" value="1000" />
		</div>

		<div class="form_input">
			<label for="stream_min">–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å—Ç—Ä–∏–º–æ–≤ –º–∏–Ω</label>
			<input type="number" id="stream_min" placeholder="stream min" value="0" />
		</div>

		<div class="form_input">
			<label for="stream_max">–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å—Ç—Ä–∏–º–æ–≤ –º–∞–∫—Å</label>
			<input type="number" id="stream_max" placeholder="stream max" value="1000" />
		</div>

		<div class="form_input">
			<label for="mods_int">–ú–æ–¥—ã</label>
			<input type="text" id="mods_int" placeholder="mods" value="NM" />
		</div>

		<div class="form_input send_button">
			<input type="button" onclick="send_request()" value="–ü–æ–ª—É—á–∏—Ç—å"/>
		</div>
	</div>
	
</body>
</html>